<!DOCTYPE html>
<html lang="ru">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimal-ui">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="imagetoolbar" content="no">
		<meta name="msthemecompatible" content="no">
		<meta name="cleartype" content="on">
		<meta name="HandheldFriendly" content="True">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<meta name="google" value="notranslate">
		<meta name="theme-color" content="#ffffff">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<link sizes="57x57" href="/apple-touch-icon-57x57.png" rel="apple-touch-icon">
		<link sizes="114x114" href="/apple-touch-icon-114x114.png" rel="apple-touch-icon">
		<link sizes="72x72" href="/apple-touch-icon-72x72.png" rel="apple-touch-icon">
		<link sizes="144x144" href="/apple-touch-icon-144x144.png" rel="apple-touch-icon">
		<link sizes="60x60" href="/apple-touch-icon-60x60.png" rel="apple-touch-icon">
		<link sizes="120x120" href="/apple-touch-icon-120x120.png" rel="apple-touch-icon">
		<link sizes="76x76" href="/apple-touch-icon-76x76.png" rel="apple-touch-icon">
		<link sizes="152x152" href="/apple-touch-icon-152x152.png" rel="apple-touch-icon">
		<link sizes="180x180" href="/apple-touch-icon-180x180.png" rel="apple-touch-icon">
		<link sizes="192x192" href="/favicon-192x192.png" rel="icon" type="image/png">
		<link sizes="160x160" href="/favicon-160x160.png" rel="icon" type="image/png">
		<link sizes="96x96" href="/favicon-96x96.png" rel="icon" type="image/png">
		<link sizes="16x16" href="/favicon-16x16.png" rel="icon" type="image/png">
		<link sizes="32x32" href="/favicon-32x32.png" rel="icon" type="image/png">
		<link rel="manifest" href="/manifest.json">
		<meta name="application-name" content="">
		<meta name="msapplication-tooltip" content="">
		<meta name="msapplication-TileColor" content="#ffffff">
		<meta name="msapplication-TileImage" content="/mstile-large.png">
		<meta name="msapplication-starturl" content="https://csssr.github.io/csssr-project-template/">
		<meta name="msapplication-tap-highlight" content="no">
		<meta name="msapplication-square70x70logo" content="/mstile-small.png">
		<meta name="msapplication-square150x150logo" content="/mstile-medium.png">
		<meta name="msapplication-wide310x150logo" content="/mstile-wide.png">
		<meta name="msapplication-square310x310logo" content="/mstile-large.png">
		<title>Transducers in PHP</title>
		<meta name="description" content="">
		<meta name="keywords" content="">
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" rel="stylesheet">
		<link href="assets/styles/app.min.css" rel="stylesheet">
	</head>

	<body class="page">
		<div class="header">
			<div class="container">
				<div class="row middle-xs">
					<div class="logo col-xs header__logo">
						<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" class="logo__image" />
					</div>
					<div class="heading col-xs">
						<h1 class="heading__title">
							<a class="heading__link">Nikolay Kostyurin</a>
						</h1>
					</div>
					<ul class="menu col-xs header__menu">
						<li class="menu__item">
							<a href="#about" class="menu__link">Projects</a>
						</li>
						<li class="menu__item">
							<a href="#about" class="menu__link">Posts</a>
						</li>
						<li class="menu__item">
							<a href="#about" class="menu__link">Github</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<article class="post">
			<div class="container post__container">
				<time datetime="asdasd" class="date post__date">
					<span class="date__label">november 05, 2016</span>
				</time>
				<header class="post__header">
					<h2 class="post__title">Transducers in PHP</h2>
				</header>
				<div class="text post__body">
					<p>There’s been a lot of talk lately about the
						<a href="https://github.com/php-fig/fig-standards/blob/master/proposed/http-message.md">PSR HTTP message proposal
						</a>, PSR-7. The purpose of the proposal is to create a shared interface that can be used by projects to interact with
						HTTP messages for both clients and servers.</p>

					<p>When I created the proposal, I envisioned the purpose is not to say projects that utilize HTTP messages need to make
						breaking changes to use the proposed interfaces, but rather give projects an interface for which they can create an
						adapter. For example, if there are swaths of changes to the proposal before it is accepted, then it is very unlikely
						for
						<a href="http://guzzlephp.org">Guzzle</a> (a very popular PHP HTTP client that I created) to utilize the interfaces directly. I also very much doubt
						that projects like Symfony or Zend Framework would update their HTTP message interfaces to match (at least in the near
						future).</p>

					<h3>Message Bodies</h3>

					<p>The biggest point of contention with the proposal so far has been deciding on how the body of an HTTP message will be
						represented. In the current proposal, the body of an HTTP message is exposed using a StreamInterface that provides
						the following methods:</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>

								<span class="k">namespace</span>
								<span class="nx">Psr\Http\Message</span>
								<span class="p">;</span>

								<span class="k">interface</span>
								<span class="nx">StreamInterface</span>
								<span class="p">{</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">__toString</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">close</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">detach</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">getSize</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">tell</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">eof</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">isSeekable</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">seek</span>
								<span class="p">(</span>
								<span class="nv">$offset</span>
								<span class="p">,</span>
								<span class="nv">$whence</span>
								<span class="o">=</span>
								<span class="nx">SEEK_SET</span>
								<span class="p">);</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">isWritable</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">write</span>
								<span class="p">(</span>
								<span class="nv">$string</span>
								<span class="p">);</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">isReadable</span>
								<span class="p">();</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">read</span>
								<span class="p">(</span>
								<span class="nv">$length</span>
								<span class="p">);</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">getContents</span>
								<span class="p">(</span>
								<span class="nv">$maxLength</span>
								<span class="o">=</span>
								<span class="o">-</span>
								<span class="mi">1</span>
								<span class="p">);</span>
								<span class="p">}</span>
							</code>
						</pre>
					</div>


					<p>As you can see, the StreamInterface provides methods that describe the stream’s capabilities (
						<code>isReadable()</code>,
						<code>isWritable()</code>,
						<code>isSeekable()</code>), can be cast to a string, and provides methods that allow you to read and write to the stream
						without having to load the entire stream into memory. Using the StreamInterface also consolidates all of the functions
						you need to interact with the data source in one easy to find place.</p>

					<p>There are several other options that could have been utilized to represent an HTTP message:</p>

					<ul>
						<li>string</li>
						<li>iterators</li>
						<li>PHP streams</li>
					</ul>


					<p>Utilizing a string would have required that the entire contents of the message be loaded into memory. This won’t work
						when you’re interacting with web services like Amazon S3 where it is common to download objects storing gigabytes of
						data.
					</p>

					<p>Utilizing iterators
						<em>could</em> work, but it would likely cause a significant performance penalty due to the fact that each call to
						<code>next()</code> would return only a single byte, resulting in a huge number of method calls to download large files.
						Furthermore, it would provide a read-only representation of a message body.</p>

					<h3>PHP Streams</h3>

					<p>PHP streams offer pretty powerful abstraction over streams of data. They allow you to implement custom stream protocols
						so that you can interact with various data sources as well as stream filters which allow you to add customizations
						to the way in which data is read or written to streams at runtime. In theory, it’s the obvious choice to use when representing
						HTTP message bodies. In practice, it suffers from various problems that make it an impractical choice as the data source
						for PSR-7.</p>

					<h3>No Auto-registering of stream protocols and filters</h3>

					<p>One of the great things about the StreamInterface approach is that you can easily implement StreamInterface to create
						stream decorators to add behavior to streams at runtime. This is an approach that I’ve utilized heavily in Guzzle:
					</p>

					<ul>
						<li>
							<a href="https://github.com/guzzle/streams/blob/master/src/CachingStream.php">Cache previously read bytes</a>
						</li>
						<li>
							<a href="https://github.com/guzzle/streams/blob/master/src/LimitStream.php">Limit the data to be read to a subset of a large stream</a>. This requires
							<code>getSize()</code>,
							<code>tell()</code>, and various other methods to be decorated to limit the wrapped stream to only a subset of the larger
							stream.
						</li>
						<li>
							<a href="https://github.com/guzzle/streams/blob/master/src/NoSeekStream.php">Prevent seeking of a stream</a>
						</li>
						<li>
							<a href="https://github.com/guzzle/message-integrity-subscriber/blob/master/src/ReadIntegrityStream.php">Implement message integrity checks</a>. This will throw an exception if a calculated rolling checksum of stream data
							as it is read does not match the expected checksum.
						</li>
						<li>
							<a href="https://github.com/guzzle/progress-subscriber/blob/master/src/UploadProgressStream.php">Provide progress information</a>
						</li>
					</ul>


					<p>To add behavior like this to PHP streams, you’d need to implement custom PHP stream wrappers and/or stream filters for
						each of the above decorators. The problem here is that you would need some kind of bootstrap script to register your
						named stream wrappers and filters before they can be utilized. There’s no way in PHP to automatically register stream
						filters or wrappers before they are used. However, PHP has long offered autoloading of classes, which is the method
						in which StreamInterface decorators would be implemented.</p>

					<h3>Exceptions cause warnings in stream wrappers and filters</h3>

					<p>I’ve been thinking lately that creating PHP resource stream decorators like I’ve listed above would be possible, and
						could be implemented relatively painlessly using PHP stream wrappers. It turns out it is!</p>

					<p>I started a GitHub repository that makes it easy to create PHP stream wrapper decorators that can implement what I’ve
						listed above:
						<a href="https://github.com/mtdowling/streamer">https://github.com/mtdowling/streamer</a>. It acts as a decorator over an existing PHP stream resource.</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="k">use</span>
								<span class="nx">GuzzleHttp\Streamer\Utils</span>
								<span class="p">;</span>
								<span class="k">use</span>
								<span class="nx">GuzzleHttp\Streamer\BaseWrapper</span>
								<span class="p">;</span>
								<span class="k">use</span>
								<span class="nx">GuzzleHttp\Streamer\NoSeek</span>
								<span class="p">;</span>

								<span class="c1">// Prevents an underlying stream from being seeked</span>
								<span class="k">class</span>
								<span class="nc">NoSeek</span>
								<span class="k">extends</span>
								<span class="nx">\GuzzleHttp\Streamer\BaseWrapper</span>
								<span class="p">{</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">stream_seek</span>
								<span class="p">(</span>
								<span class="nv">$offset</span>
								<span class="p">,</span>
								<span class="nv">$whence</span>
								<span class="p">)</span>
								<span class="p">{</span>
								<span class="k">return</span>
								<span class="k">false</span>
								<span class="p">;</span>
								<span class="p">}</span>
								<span class="p">}</span>

								<span class="nv">$base</span>
								<span class="o">=</span>
								<span class="nx">Utils</span>
								<span class="o">::</span>
								<span class="na">create</span>
								<span class="p">(</span>
								<span class="s1">'foobar'</span>
								<span class="p">);</span>
								<span class="nv">$f</span>
								<span class="o">=</span>
								<span class="nx">NoSeek</span>
								<span class="o">::</span>
								<span class="na">wrap</span>
								<span class="p">(</span>
								<span class="nv">$base</span>
								<span class="p">);</span>
								<span class="k">echo</span>
								<span class="nb">fread</span>
								<span class="p">(</span>
								<span class="nv">$f</span>
								<span class="p">,</span>
								<span class="mi">10</span>
								<span class="p">);</span>
								<span class="c1">// Outputs "foobar"</span>
								<span class="nb">fseek</span>
								<span class="p">(</span>
								<span class="nv">$f</span>
								<span class="p">,</span>
								<span class="mi">0</span>
								<span class="p">);</span>
								<span class="k">echo</span>
								<span class="nb">fread</span>
								<span class="p">(</span>
								<span class="nv">$f</span>
								<span class="p">,</span>
								<span class="mi">10</span>
								<span class="p">);</span>
								<span class="c1">// Outputs ""</span>
							</code>
						</pre>
					</div>


					<p>That’s awesome!</p>

					<p>The problem with this approach is that PHP streams suffer from PHP’s legacy of emitting errors and warnings. Let’s say
						you wanted to implement a message integrity check that creates a rolling checksum as data is read from a stream. When
						the last byte of data is read, the checksum is computed and validated against an expected value. If the checksums do
						not match, then you’d throw an exception.</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="k">class</span>
								<span class="nc">ThrowDecorator</span>
								<span class="k">extends</span>
								<span class="nx">\GuzzleHttp\Streamer\BaseWrapper</span>
								<span class="p">{</span>
								<span class="k">public</span>
								<span class="k">function</span>
								<span class="nf">stream_read</span>
								<span class="p">(</span>
								<span class="nv">$count</span>
								<span class="p">)</span>
								<span class="p">{</span>
								<span class="c1">// Assume it's the last byte and there is a mismatch</span>
								<span class="k">throw</span>
								<span class="k">new</span>
								<span class="nx">\RuntimeException</span>
								<span class="p">(</span>
								<span class="s1">'Checksum mismatch!'</span>
								<span class="p">);</span>
								<span class="p">}</span>
								<span class="p">}</span>

								<span class="nv">$base</span>
								<span class="o">=</span>
								<span class="nx">Utils</span>
								<span class="o">::</span>
								<span class="na">create</span>
								<span class="p">(</span>
								<span class="s1">'foobar'</span>
								<span class="p">);</span>
								<span class="nv">$f</span>
								<span class="o">=</span>
								<span class="nx">ThrowDecorator</span>
								<span class="o">::</span>
								<span class="na">wrap</span>
								<span class="p">(</span>
								<span class="nv">$base</span>
								<span class="p">);</span>
								<span class="nb">fread</span>
								<span class="p">(</span>
								<span class="nv">$f</span>
								<span class="p">,</span>
								<span class="mi">10</span>
								<span class="p">);</span>
							</code>
						</pre>
					</div>


					<p>Running the above example will always emit the following PHP warning followed by throwing the exception:</p>

					<pre>
						<code>PHP Warning: fread(): ThrowDecorator::stream_eof is not implemented! Assuming EOF in test.php
						</code>
					</pre>

					<p>So even though
						<code>stream_eof()</code> is implemented, throwing an exception inside of
						<code>stream_read()</code>
						will always emit the above warning.</p>

					<p>“This should be implemented as a stream filter!” you might say. Ok, let’s try that:</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>

								<span class="k">class</span>
								<span class="nc">ThrowFilter</span>
								<span class="k">extends</span>
								<span class="k">php_user_filter</span>
								<span class="p">{</span>
								<span class="k">function</span>
								<span class="nf">filter</span>
								<span class="p">(</span>
								<span class="nv">$in</span>
								<span class="p">,</span>
								<span class="nv">$out</span>
								<span class="p">,</span>
								<span class="o">&amp;</span>
								<span class="nv">$consumed</span>
								<span class="p">,</span>
								<span class="nv">$closing</span>
								<span class="p">)</span>
								<span class="p">{</span>
								<span class="c1">// Just throw immediately as an example</span>
								<span class="k">throw</span>
								<span class="k">new</span>
								<span class="nx">\RuntimeException</span>
								<span class="p">(</span>
								<span class="s1">'Checksum mismatch!'</span>
								<span class="p">);</span>
								<span class="p">}</span>
								<span class="p">}</span>

								<span class="nb">stream_filter_register</span>
								<span class="p">(</span>
								<span class="s1">'throws'</span>
								<span class="p">,</span>
								<span class="s1">'ThrowFilter'</span>
								<span class="p">);</span>
								<span class="nv">$fp</span>
								<span class="o">=</span>
								<span class="nb">fopen</span>
								<span class="p">(</span>
								<span class="s1">'/tmp/foo'</span>
								<span class="p">,</span>
								<span class="s1">'r'</span>
								<span class="p">);</span>
								<span class="nb">stream_filter_append</span>
								<span class="p">(</span>
								<span class="nv">$fp</span>
								<span class="p">,</span>
								<span class="s1">'throws'</span>
								<span class="p">);</span>
								<span class="nb">fread</span>
								<span class="p">(</span>
								<span class="nv">$fp</span>
								<span class="p">,</span>
								<span class="s2">"Line1</span>
								<span class="se">\n</span>
								<span class="s2">"</span>
								<span class="p">);</span>
							</code>
						</pre>
					</div>


					<p>When the above example is run it emits a PHP warning before throwing the exception:</p>

					<pre>
						<code>PHP Warning: fread(): Unprocessed filter buckets remaining on input brigade in test.php on line 20
						</code>
					</pre>

					<p>The fact that PHP streams do not allow you to throw exceptions in the various abstractions poses a huge usability issue
						that basically renders them useless if you were wanting to decorate the behavior at runtime without resorting to emitting
						PHP warnings and errors rather than utilizing PHP exceptions.</p>

					<h3>Cannot be cast to a string</h3>

					<p>Because it implements
						<code>__toString()</code>, the StreamInterface approach allows the convenience of being able to treat a stream of data as
						a string while still allowing for the flexibility of not loading a bunch of data all into memory. This feature will
						make libraries implementing this proposal much more accessible to new users without making any tradeoffs in terms of
						encapsulation or flexibility.</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="c1">// Outputs the string representation</span>
								<span class="k">echo</span>
								<span class="nv">$message</span>
								<span class="o">-&gt;</span>
								<span class="na">getBody</span>
								<span class="p">();</span>
							</code>
						</pre>
					</div>


					<p>On the other hand, using PHP streams directly would require boilerplate code each time you want to convert a message
						body to a string:</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="nv">$resource</span>
								<span class="o">=</span>
								<span class="nv">$message</span>
								<span class="o">-&gt;</span>
								<span class="na">getBody</span>
								<span class="p">();</span>
								<span class="nb">rewind</span>
								<span class="p">(</span>
								<span class="nv">$resource</span>
								<span class="p">);</span>
								<span class="k">echo</span>
								<span class="nb">stream_get_contents</span>
								<span class="p">(</span>
								<span class="nv">$resource</span>
								<span class="p">);</span>
							</code>
						</pre>
					</div>


					<h3>Functionality is spread over many functions</h3>

					<p>To interact with PHP streams and get the same level of usability as the StreamInterface, you’d need to interact with
						many different methods that aren’t always easy to find (especially for a new user).</p>

					<p>What if you wanted to know the amount of data in a PHP stream? When using the StreamInterface, it’s a simple call to
						<code>getSize()</code>. When using PHP streams, it requires the following code:</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="nv">$stats</span>
								<span class="o">=</span>
								<span class="nb">fstat</span>
								<span class="p">(</span>
								<span class="nv">$resource</span>
								<span class="p">);</span>

								<span class="k">if</span>
								<span class="p">(</span>
								<span class="nb">isset</span>
								<span class="p">(</span>
								<span class="nv">$stats</span>
								<span class="p">[</span>
								<span class="s1">'size'</span>
								<span class="p">]))</span>
								<span class="p">{</span>
								<span class="nv">$size</span>
								<span class="o">=</span>
								<span class="nv">$stats</span>
								<span class="p">[</span>
								<span class="s1">'size'</span>
								<span class="p">];</span>
								<span class="p">}</span>
								<span class="k">else</span>
								<span class="p">{</span>
								<span class="nv">$size</span>
								<span class="o">=</span>
								<span class="k">null</span>
								<span class="p">;</span>
								<span class="p">}</span>
							</code>
						</pre>
					</div>


					<p>What if you wanted to know whether or not a stream is seekable? Using the StreamInterface, it’s a simple call to
						<code>isSeekable()</code>. When using PHP streams, you need the following code:</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="nv">$meta</span>
								<span class="o">=</span>
								<span class="nb">stream_get_meta_data</span>
								<span class="p">(</span>
								<span class="nv">$resource</span>
								<span class="p">);</span>
								<span class="nv">$seekable</span>
								<span class="o">=</span>
								<span class="nv">$meta</span>
								<span class="p">[</span>
								<span class="s1">'seekable'</span>
								<span class="p">];</span>
							</code>
						</pre>
					</div>


					<p>That wasn’t too bad. But what if you wanted to know whether or not a stream is readable? Using the StreamInterface:
						<code>isReadable()</code>. Using PHP streams:</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="nv">$meta</span>
								<span class="o">=</span>
								<span class="nb">stream_get_meta_data</span>
								<span class="p">(</span>
								<span class="nv">$resource</span>
								<span class="p">);</span>
								<span class="nv">$mode</span>
								<span class="o">=</span>
								<span class="nv">$meta</span>
								<span class="p">[</span>
								<span class="s1">'mode'</span>
								<span class="p">];</span>
								<span class="nv">$readableModes</span>
								<span class="o">=</span>
								<span class="p">[</span>
								<span class="s1">'r'</span>
								<span class="p">,</span>
								<span class="s1">'w+'</span>
								<span class="p">,</span>
								<span class="s1">'r+'</span>
								<span class="p">,</span>
								<span class="s1">'x+'</span>
								<span class="p">,</span>
								<span class="s1">'c+'</span>
								<span class="p">,</span>
								<span class="s1">'rb'</span>
								<span class="p">,</span>
								<span class="s1">'w+b'</span>
								<span class="p">,</span>
								<span class="s1">'r+b'</span>
								<span class="p">,</span>
								<span class="s1">'x+b'</span>
								<span class="p">,</span>
								<span class="s1">'c+b'</span>
								<span class="p">,</span>
								<span class="s1">'rt'</span>
								<span class="p">,</span>
								<span class="s1">'w+t'</span>
								<span class="p">,</span>
								<span class="s1">'r+t'</span>
								<span class="p">,</span>
								<span class="s1">'x+t'</span>
								<span class="p">,</span>
								<span class="s1">'c+t'</span>
								<span class="p">,</span>
								<span class="s1">'a+'</span>
								<span class="p">];</span>
								<span class="nv">$isReadable</span>
								<span class="o">=</span>
								<span class="nb">in_array</span>
								<span class="p">(</span>
								<span class="nv">$mode</span>
								<span class="p">,</span>
								<span class="nv">$readableModes</span>
								<span class="p">);</span>
							</code>
						</pre>
					</div>


					<p>A similar approach would need to be taken to know if a stream is writable. As you can see attempting to get the same
						functionality of a StreamInterface using native PHP streams would require quite a bit of boilerplate code.</p>

					<p>Just for reference, here are links to PHP stream related functions and filesystem functions that can be used with PHP
						streams:
					</p>

					<ul>
						<li>Filesystem functions:
							<a href="http://php.net/manual/en/ref.filesystem.php">http://php.net/manual/en/ref.filesystem.php</a>
						</li>
						<li>Stream functions:
							<a href="http://php.net/manual/en/ref.stream.php">http://php.net/manual/en/ref.stream.php</a>
						</li>
					</ul>


					<h3>StreamInterface concerns</h3>

					<p>Even with the all of the problems that come with using PHP streams directly, various members of the mailing list has
						raised concerns about the StreamInterface approach. The most common concern is that there is no way to get a native
						PHP stream from a StreamInterface.</p>

					<pre>
						<code>The biggest thing I'm missing from the stream api, is to get to the underlying stream. -- We have to ensure that the
							common case is performant, and that it's possible to take advantage of PHP's (fairly robust) stream handling capabilities
							when feasible. I totally get the portability and simplicity benefits of abstracting it away from stream API, but there
							needs to be a way to use, well, PHP, and do so performantly.
						</code>
					</pre>

					<p>You want a way to represent a stream abstraction that does not necessarily actually wrap a PHP stream to be able to
						be used like a PHP stream. This can be achieved in a number of different ways.</p>

					<h3>Creating a PHP stream from a StreamInterface</h3>

					<p>When using Guzzle streams (a 1:1 implementation of the proposed StreamInterface), you can convert any StreamInterface
						instance to a PHP stream using a custom PHP stream wrapper:
						<a href="https://github.com/guzzle/streams/blob/master/src/GuzzleStreamWrapper.php:">https://github.com/guzzle/streams/blob/master/src/GuzzleStreamWrapper.php:</a>
					</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="k">use</span>
								<span class="nx">GuzzleHttp\Stream</span>
								<span class="p">;</span>
								<span class="k">use</span>
								<span class="nx">GuzzleHttp\Stream\GuzzleStreamWrapper</span>
								<span class="p">;</span>

								<span class="c1">// Create a Guzzle stream</span>
								<span class="nv">$stream</span>
								<span class="o">=</span>
								<span class="nx">Stream\create</span>
								<span class="p">(</span>
								<span class="s1">'this is a string body'</span>
								<span class="p">);</span>

								<span class="c1">// Create a PHP stream from the Guzzle stream that just wraps the Guzzle stream</span>
								<span class="nv">$resource</span>
								<span class="o">=</span>
								<span class="nx">GuzzleStreamWrapper</span>
								<span class="o">::</span>
								<span class="na">getResource</span>
								<span class="p">(</span>
								<span class="nv">$stream</span>
								<span class="p">);</span>
								<span class="k">echo</span>
								<span class="nb">fread</span>
								<span class="p">(</span>
								<span class="nv">$resource</span>
								<span class="p">,</span>
								<span class="mi">4</span>
								<span class="p">);</span>
								<span class="c1">// Outputs "this"</span>

								<span class="c1">// Notice that the original stream is still in a consistent state</span>
								<span class="k">echo</span>
								<span class="nv">$stream</span>
								<span class="o">-&gt;</span>
								<span class="na">tell</span>
								<span class="p">();</span>
								<span class="c1">// 4</span>
								<span class="k">echo</span>
								<span class="nb">ftell</span>
								<span class="p">(</span>
								<span class="nv">$resource</span>
								<span class="p">);</span>
								<span class="c1">// 4</span>
							</code>
						</pre>
					</div>


					<p>The great thing about this approach is that it does not break the abstraction of StreamInterface. For example, if you’ve
						decorated the stream to add various capabilities (e.g., checksum validation when the last byte is read), those same
						capabilities will still be utilized when using the native PHP stream resource that wraps the Guzzle stream. This would
						be the ideal approach to utilize when trying to use a StreamInterface as a native PHP stream.</p>

					<h3>Getting the underlying PHP stream from a StreamInterface</h3>

					<p>While there’s no requirement that a StreamInterface actually wraps a PHP stream resource (e.g., reading from strings,
						reading mocked data, etc.), it will often be the case when interacting with things like files on disks or remote sockets.
						In these cases, you might want to get the actual underlying stream resource from the StreamInterface.</p>

					<p>If the StreamInterface were able to return an underlying resources that can be mutated, then you would be breaking the
						abstraction by abandoning any decorators and you would be leaving the StreamInterface in an inconsistent state. Because
						of this, the only way that the StreamInterface should return an actual underlying PHP stream resource should be when
						the
						<code>detach()</code> method is called (a method that already promises to leave a StreamInterface in an inconsistent state).
						Calling
						<code>StreamInterface::detach()</code> would return
						<code>null</code> if the StreamInterface doesn’t actually wrap an underlying resource, or would return a PHP stream resource
						if one is utilized.
					</p>

					<p>As a matter of fact, I recently pushed a change to Guzzle’s streams API that implements this change:
						<a href="https://github.com/guzzle/streams/commit/368ee042ef5d88ffbc19632e0c114a54a3ac45b2.">https://github.com/guzzle/streams/commit/368ee042ef5d88ffbc19632e0c114a54a3ac45b2.</a>
						While detaching the underlying resource will not utilize any decorators that have been attached to the StreamInterface, it
						will provide a native PHP stream resource that does not need to utilize a custom Guzzle stream wrapper.
					</p>

					<div class="highlight">
						<pre>
							<code class="php">
								<span class="cp">&lt;?php</span>
								<span class="k">use</span>
								<span class="nx">GuzzleHttp\Stream</span>
								<span class="p">;</span>

								<span class="nv">$stream</span>
								<span class="o">=</span>
								<span class="nx">Stream\create</span>
								<span class="p">(</span>
								<span class="nb">fopen</span>
								<span class="p">(</span>
								<span class="s1">'/tmp/foo'</span>
								<span class="p">,</span>
								<span class="s1">'r'</span>
								<span class="p">));</span>
								<span class="nv">$resource</span>
								<span class="o">=</span>
								<span class="nv">$stream</span>
								<span class="o">-&gt;</span>
								<span class="na">detach</span>
								<span class="p">();</span>
							</code>
						</pre>
					</div>


					<p>I think that a similar change to the StreamInterface proposed in in PSR-7 should be made.</p>

					<h3>Summary</h3>

					<p>I’ve outlined the different approaches that can be taken to represent HTTP message bodies in PSR-7 and provided more
						motiviation as to why I proposed the StreamInterface solution. Using PHP streams directly does not allow for a robust
						stream decoration strategy due to the fact that PHP streams suffers from legacy PHP warnings and errors. By showing
						how you can use a custom stream wrapper to convert a StreamInterface to a PHP stream and by returning the underlying
						PHP stream resource when the
						<code>StreamInterface::detach()</code> method is called, I’ve addressed the concern that you cannot utilize native PHP streams
						when using a StreamInterface abstraction.</p>
				</div>
				<footer class="post__footer">
					<div class="tags post__tags">
						<span class="tags__tag">Tag 1</span>
						<span class="tags__tag">Tag 2</span>
						<span class="tags__tag">Tag 3</span>
					</div>
				</footer>
			</div>
		</article>
		<div class="comments">
			<div class="container">
				<header class="comments__header">
					<h2 class="comments__title">8 comments</h2>
					<a href="#" title="Subscribe to comments RSS Feed" class="comments__feed">
						<i class="material-icons comments__feed-icon">rss_feed</i>
					</a>
					<a href="#" title="Subscribe to comments via email" class="comments__email">
						<i class="material-icons comments__email-icon">email</i>
					</a>
				</header>
				<div class="comment-list comments__list">
					<div class="comment comment-list__item">
						<section class="comment__body">
							<header class="comment__header">
								<div class="avatar comment__avatar">
									<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image" />
								</div>
								<a href="asdasd" class="link comment__author">Nikolay Kost</a>
								<time datetime="10.11.2016, 16:28:40" class="date comment__date">
									<span class="date__label">10.11.2016, 16:28:40</span>
								</time>
								<a href="#12312" class="link comment__id">#</a>
							</header>
							<div class="text comment__text">
								<p>And now…transducers are available in PHP via transducers.php!</p>
							</div>
						</section>
						<section class="comment__responses">
							<div class="comment comment-list__item">
								<section class="comment__body">
									<header class="comment__header">
										<div class="avatar comment__avatar">
											<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image" />
										</div>
										<a href="asdasd" class="link comment__author">Nikolay Kost</a>
										<time datetime="10.11.2016, 16:28:40" class="date comment__date">
											<span class="date__label">10.11.2016, 16:28:40</span>
										</time>
										<a href="#12312" class="link comment__id">#</a>
									</header>
									<div class="text comment__text">
										<p>And now…transducers are available in PHP via transducers.php!</p>
									</div>
								</section>
								<section class="comment__responses"></section>
							</div>
						</section>
					</div>
					<div class="comment comment-list__item">
						<section class="comment__body">
							<header class="comment__header">
								<div class="avatar comment__avatar">
									<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image" />
								</div>
								<a href="asdasd" class="link comment__author">Nikolay Kost</a>
								<time datetime="10.11.2016, 16:28:40" class="date comment__date">
									<span class="date__label">10.11.2016, 16:28:40</span>
								</time>
								<a href="#12312" class="link comment__id">#</a>
							</header>
							<div class="text comment__text">
								<p>And now…transducers are available in PHP via transducers.php!</p>
							</div>
						</section>
						<section class="comment__responses">
							<div class="comment comment-list__item">
								<section class="comment__body">
									<header class="comment__header">
										<div class="avatar comment__avatar">
											<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image" />
										</div>
										<a href="asdasd" class="link comment__author">Nikolay Kost</a>
										<time datetime="10.11.2016, 16:28:40" class="date comment__date">
											<span class="date__label">10.11.2016, 16:28:40</span>
										</time>
										<a href="#12312" class="link comment__id">#</a>
									</header>
									<div class="text comment__text">
										<p>And now…transducers are available in PHP via transducers.php!</p>
									</div>
								</section>
								<section class="comment__responses">
									<div class="comment comment-list__item">
										<section class="comment__body">
											<header class="comment__header">
												<div class="avatar comment__avatar">
													<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
													/>
												</div>
												<a href="asdasd" class="link comment__author">Nikolay Kost</a>
												<time datetime="10.11.2016, 16:28:40" class="date comment__date">
													<span class="date__label">10.11.2016, 16:28:40</span>
												</time>
												<a href="#12312" class="link comment__id">#</a>
											</header>
											<div class="text comment__text">
												<p>And now…transducers are available in PHP via transducers.php!</p>
											</div>
										</section>
										<section class="comment__responses">
											<div class="comment comment-list__item">
												<section class="comment__body">
													<header class="comment__header">
														<div class="avatar comment__avatar">
															<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
															/>
														</div>
														<a href="asdasd" class="link comment__author">Nikolay Kost</a>
														<time datetime="10.11.2016, 16:28:40" class="date comment__date">
															<span class="date__label">10.11.2016, 16:28:40</span>
														</time>
														<a href="#12312" class="link comment__id">#</a>
													</header>
													<div class="text comment__text">
														<p>And now…transducers are available in PHP via transducers.php!</p>
													</div>
												</section>
												<section class="comment__responses">
													<div class="comment comment-list__item">
														<section class="comment__body">
															<header class="comment__header">
																<div class="avatar comment__avatar">
																	<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
																	/>
																</div>
																<a href="asdasd" class="link comment__author">Nikolay Kost</a>
																<time datetime="10.11.2016, 16:28:40" class="date comment__date">
																	<span class="date__label">10.11.2016, 16:28:40</span>
																</time>
																<a href="#12312" class="link comment__id">#</a>
															</header>
															<div class="text comment__text">
																<p>And now…transducers are available in PHP via transducers.php!</p>
															</div>
														</section>
														<section class="comment__responses">
															<div class="comment comment-list__item">
																<section class="comment__body">
																	<header class="comment__header">
																		<div class="avatar comment__avatar">
																			<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
																			/>
																		</div>
																		<a href="asdasd" class="link comment__author">Nikolay Kost</a>
																		<time datetime="10.11.2016, 16:28:40" class="date comment__date">
																			<span class="date__label">10.11.2016, 16:28:40</span>
																		</time>
																		<a href="#12312" class="link comment__id">#</a>
																	</header>
																	<div class="text comment__text">
																		<p>And now…transducers are available in PHP via transducers.php!</p>
																	</div>
																</section>
																<section class="comment__responses">
																	<div class="comment comment-list__item">
																		<section class="comment__body">
																			<header class="comment__header">
																				<div class="avatar comment__avatar">
																					<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
																					/>
																				</div>
																				<a href="asdasd" class="link comment__author">Nikolay Kost</a>
																				<time datetime="10.11.2016, 16:28:40" class="date comment__date">
																					<span class="date__label">10.11.2016, 16:28:40</span>
																				</time>
																				<a href="#12312" class="link comment__id">#</a>
																			</header>
																			<div class="text comment__text">
																				<p>And now…transducers are available in PHP via transducers.php!</p>
																			</div>
																		</section>
																		<section class="comment__responses">
																			<div class="comment comment-list__item">
																				<section class="comment__body">
																					<header class="comment__header">
																						<div class="avatar comment__avatar">
																							<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
																							/>
																						</div>
																						<a href="asdasd" class="link comment__author">Nikolay Kost</a>
																						<time datetime="10.11.2016, 16:28:40" class="date comment__date">
																							<span class="date__label">10.11.2016, 16:28:40</span>
																						</time>
																						<a href="#12312" class="link comment__id">#</a>
																					</header>
																					<div class="text comment__text">
																						<p>And now…transducers are available in PHP via transducers.php!</p>
																					</div>
																				</section>
																				<section class="comment__responses">
																					<div class="comment comment-list__item">
																						<section class="comment__body">
																							<header class="comment__header">
																								<div class="avatar comment__avatar">
																									<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
																									/>
																								</div>
																								<a href="asdasd" class="link comment__author">Nikolay Kost</a>
																								<time datetime="10.11.2016, 16:28:40" class="date comment__date">
																									<span class="date__label">10.11.2016, 16:28:40</span>
																								</time>
																								<a href="#12312" class="link comment__id">#</a>
																							</header>
																							<div class="text comment__text">
																								<p>And now…transducers are available in PHP via transducers.php!</p>
																							</div>
																						</section>
																						<section class="comment__responses">
																							<div class="comment comment-list__item">
																								<section class="comment__body">
																									<header class="comment__header">
																										<div class="avatar comment__avatar">
																											<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
																											/>
																										</div>
																										<a href="asdasd" class="link comment__author">Nikolay Kost</a>
																										<time datetime="10.11.2016, 16:28:40" class="date comment__date">
																											<span class="date__label">10.11.2016, 16:28:40</span>
																										</time>
																										<a href="#12312" class="link comment__id">#</a>
																									</header>
																									<div class="text comment__text">
																										<p>And now…transducers are available in PHP via transducers.php!</p>
																									</div>
																								</section>
																								<section class="comment__responses">
																									<div class="comment comment-list__item">
																										<section class="comment__body">
																											<header class="comment__header">
																												<div class="avatar comment__avatar">
																													<img src="https://avatars0.githubusercontent.com/u/62051?v=3&amp;s=460" alt="NickName" class="avatar__image"
																													/>
																												</div>
																												<a href="asdasd" class="link comment__author">Nikolay Kost</a>
																												<time datetime="10.11.2016, 16:28:40" class="date comment__date">
																													<span class="date__label">10.11.2016, 16:28:40</span>
																												</time>
																												<a href="#12312" class="link comment__id">#</a>
																											</header>
																											<div class="text comment__text">
																												<p>And now…transducers are available in PHP via transducers.php!</p>
																											</div>
																										</section>
																										<section class="comment__responses"></section>
																									</div>
																								</section>
																							</div>
																						</section>
																					</div>
																				</section>
																			</div>
																		</section>
																	</div>
																</section>
															</div>
														</section>
													</div>
												</section>
											</div>
										</section>
									</div>
								</section>
							</div>
						</section>
					</div>
					<form action="post.html/comment" class="comment-form comment-list__form">
						<div class="form-group">
							<textarea placeholder="Text here..." class="form-control comment-form__textarea"></textarea>
						</div>
						<button type="submit" class="btn btn-primary btn-sm">Post</button>
					</form>
				</div>
				<div class="comments__form"></div>
			</div>
		</div>
		<script src="assets/scripts/app.min.js"></script>
		<div class="footer">
			<div class="container">© Blog Author, 2020</div>
		</div>
	</body>

</html>
